<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Enhanced Solar System 3D â€” with AR fix</title>

  <!-- React + ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Three.js -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>

  <style>
    html,body { height:100%; margin:0; background:#000011; font-family: Arial, sans-serif; }
    #root { width:100vw; height:100vh; position:relative; overflow:hidden; touch-action: manipulation; }
    .title { position:absolute; left:15px; top:15px; z-index:12; background: rgba(0,0,0,0.7); padding:10px 16px; border-radius:10px; }
    .title h2 { margin:0; font-size:1.15rem; background: linear-gradient(45deg,#ff6b35,#f7931e); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    .debug-info { position:absolute; left:15px; top:70px; z-index:12; background: rgba(0,0,0,0.85); padding:8px 10px; border-radius:6px; font-family:monospace; font-size:12px; }
    .planet-info { position:absolute; z-index:20; background: rgba(0,0,0,0.9); color:#fff; padding:18px; border-radius:12px; border:2px solid #ff6b35; max-width:320px; backdrop-filter: blur(8px); }
    .close-btn { position:absolute; right:12px; top:8px; background:none; border:none; color:#ff6b35; font-size:18px; cursor:pointer; }
    .ar-button { position:absolute; right:15px; top:15px; z-index:12; padding:10px 14px; border-radius:18px; border:none; cursor:pointer; background: linear-gradient(45deg,#666,#888); color:white; opacity:0.9; }
    .instructions { position:absolute; left:15px; right:15px; bottom:15px; z-index:12; background:rgba(0,0,0,0.85); padding:10px; border-radius:10px; text-align:center; font-size:0.92rem; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script>
  (function () {
    const React = window.React;
    const ReactDOM = window.ReactDOM;
    const { useRef, useEffect, useState } = React;
    const THREE = window.THREE;

    function SolarSystemApp() {
      const mountRef = useRef(null);
      const rendererRef = useRef(null);
      const cameraRef = useRef(null);
      const [debugInfo, setDebugInfo] = useState('Initializing...');
      const [debugIsError, setDebugIsError] = useState(false);
      const [xrSession, setXrSession] = useState(null);

      function updateDebug(msg, isError=false) {
        setDebugInfo(msg);
        setDebugIsError(Boolean(isError));
        console.log("Debug:", msg);
      }

      useEffect(() => {
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 100);
        camera.position.z = 3;
        cameraRef.current = camera;

        const renderer = new THREE.WebGLRenderer({ alpha:true, antialias:true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;
        rendererRef.current = renderer;
        mountRef.current.appendChild(renderer.domElement);

        // Add sample planet (replace with your system later)
        const planet = new THREE.Mesh(
          new THREE.SphereGeometry(0.2,32,32),
          new THREE.MeshStandardMaterial({ color:0xffaa00 })
        );
        planet.position.set(0,0,-1);
        scene.add(planet);

        const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
        scene.add(light);

        renderer.setAnimationLoop(() => renderer.render(scene, camera));

        return () => {
          try { renderer.dispose(); } catch(e){}
          mountRef.current?.removeChild(renderer.domElement);
        };
      }, []);

      // Merged AR Start
      async function startAR() {
        if (!navigator.xr) {
          updateDebug("WebXR not supported", true);
          return;
        }
        try {
          let session;
          try {
            session = await navigator.xr.requestSession("immersive-ar", {
              requiredFeatures: ["local-floor"],
              optionalFeatures: ["unbounded","hit-test"]
            });
            updateDebug("âœ… AR session started with local-floor");
          } catch(err) {
            console.warn("Fallback to local:", err);
            session = await navigator.xr.requestSession("immersive-ar", {
              requiredFeatures: ["local"],
              optionalFeatures: ["unbounded","hit-test"]
            });
            updateDebug("âœ… AR session started with local");
          }

          const gl = rendererRef.current.getContext();
          await gl.makeXRCompatible();
          session.updateRenderState({ baseLayer: new XRWebGLLayer(session, gl) });

          rendererRef.current.xr.setSession(session);
          setXrSession(session);

          session.addEventListener("end", () => {
            setXrSession(null);
            updateDebug("AR session ended");
          });
        } catch(err) {
          updateDebug("Failed to start AR: " + err.message, true);
        }
      }

      return React.createElement("div",{ref:mountRef,style:{width:"100%",height:"100%"}},[
        React.createElement("div",{key:"title",className:"title"},
          React.createElement("h2",null,"ðŸŒž Enhanced Solar System 3D")
        ),
        React.createElement("div",{key:"debug",className:"debug-info",style:{color:debugIsError?"#ff6b6b":"#00ff00"}},debugInfo),
        React.createElement("button",{key:"arbtn",className:"ar-button",onClick:async()=>{
          if(xrSession){ try{ await xrSession.end(); }catch(e){} }
          else { await startAR(); }
        }}, xrSession?"Exit AR":"ðŸ”§ Start AR")
      ]);
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(React.createElement(SolarSystemApp));
  })();
  </script>
</body>
</html>
