<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Solar System AR</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
            touch-action: none;
        }
        
        .planet-info {
            position: absolute;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #ff6b35;
            max-width: 300px;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        
        .planet-info h3 {
            margin: 0 0 10px 0;
            color: #ff6b35;
            font-size: 1.4em;
        }
        
        .planet-info p {
            margin: 5px 0;
            line-height: 1.4;
        }
        
        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: #ff6b35;
            font-size: 1.5em;
            cursor: pointer;
        }

        .debug-info {
            position: absolute;
            top: 100px;
            left: 15px;
            background: rgba(0,0,0,0.8);
            color: #00ff00;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            z-index: 20;
            max-width: 300px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const SolarSystemAR = () => {
            const mountRef = useRef(null);
            const sceneRef = useRef(null);
            const rendererRef = useRef(null);
            const cameraRef = useRef(null);
            const planetsRef = useRef([]);
            const sunRef = useRef(null);
            const clockRef = useRef(null);
            const raycasterRef = useRef(null);
            
            const [arSupported, setArSupported] = useState(false);
            const [isChecking, setIsChecking] = useState(true);
            const [arActive, setArActive] = useState(false);
            const [xrSession, setXrSession] = useState(null);
            const [selectedPlanet, setSelectedPlanet] = useState(null);
            const [planetInfoPos, setPlanetInfoPos] = useState({ x: 0, y: 0 });
            const [debugInfo, setDebugInfo] = useState('Initializing...');

            const planetData = [
                { 
                    name: 'Mercury', 
                    size: 0.15,
                    distance: 0.8, 
                    speed: 0.8, 
                    color: 0x8c7853,
                    details: {
                        diameter: '4,879 km',
                        distance: '57.9 million km from Sun',
                        day: '176 Earth days',
                        year: '88 Earth days',
                        facts: 'Closest to the Sun, extreme temperatures'
                    }
                },
                { 
                    name: 'Venus', 
                    size: 0.18,
                    distance: 1.1, 
                    speed: 0.6, 
                    color: 0xffc649,
                    details: {
                        diameter: '12,104 km',
                        distance: '108.2 million km from Sun', 
                        day: '243 Earth days',
                        year: '225 Earth days',
                        facts: 'Hottest planet, thick atmosphere'
                    }
                },
                { 
                    name: 'Earth', 
                    size: 0.18,
                    distance: 1.4, 
                    speed: 0.5, 
                    color: 0x6b93d6,
                    details: {
                        diameter: '12,756 km',
                        distance: '149.6 million km from Sun',
                        day: '24 hours',
                        year: '365.25 days', 
                        facts: 'Only known planet with life'
                    }
                },
                { 
                    name: 'Mars', 
                    size: 0.14,
                    distance: 1.8, 
                    speed: 0.4, 
                    color: 0xc1440e,
                    details: {
                        diameter: '6,792 km',
                        distance: '227.9 million km from Sun',
                        day: '24.6 hours', 
                        year: '687 Earth days',
                        facts: 'Red planet, has polar ice caps'
                    }
                },
                { 
                    name: 'Jupiter', 
                    size: 0.4,
                    distance: 2.5, 
                    speed: 0.25, 
                    color: 0xd8ca9d,
                    details: {
                        diameter: '142,984 km',
                        distance: '778.5 million km from Sun',
                        day: '9.9 hours',
                        year: '11.9 Earth years',
                        facts: 'Largest planet, Great Red Spot'
                    }
                },
                { 
                    name: 'Saturn', 
                    size: 0.35,
                    distance: 3.2, 
                    speed: 0.2, 
                    color: 0xfad5a5,
                    details: {
                        diameter: '120,536 km',
                        distance: '1.43 billion km from Sun', 
                        day: '10.7 hours',
                        year: '29.4 Earth years',
                        facts: 'Famous for its ring system'
                    }
                }
            ];

            const sunData = {
                name: 'The Sun',
                details: {
                    diameter: '1.39 million km',
                    distance: 'Center of Solar System',
                    temperature: '5,778 K surface / 15 million K core',
                    composition: '73% Hydrogen, 25% Helium',
                    age: '4.6 billion years',
                    facts: 'Contains 99.86% of Solar System mass, powers all life on Earth'
                }
            };

            // DRAG CONTROLS - Simple mouse/touch drag to orbit
            const controls = useRef({
                isDragging: false,
                startX: 0,
                startY: 0,
                rotationX: 0,
                rotationY: 0,
                distance: 8
            });

            const updateDebug = (message) => {
                console.log('AR Debug:', message);
                setDebugInfo(message);
            };

            // Check AR support
            useEffect(() => {
                const checkARSupport = async () => {
                    updateDebug('Checking WebXR support...');
                    
                    if (!navigator.xr) {
                        updateDebug('‚ùå navigator.xr not found');
                        setIsChecking(false);
                        return;
                    }

                    try {
                        const supported = await navigator.xr.isSessionSupported('immersive-ar');
                        updateDebug(supported ? '‚úÖ AR supported' : '‚ùå AR not supported');
                        setArSupported(supported);
                    } catch (error) {
                        updateDebug(`‚ùå AR check failed: ${error.message}`);
                        setArSupported(false);
                    } finally {
                        setIsChecking(false);
                    }
                };

                checkARSupport();
            }, []);

            const createSimplePlanetMaterial = (planetInfo) => {
                const THREE = window.THREE;
                return new THREE.MeshPhongMaterial({ 
                    color: planetInfo.color,
                    shininess: 10
                });
            };

            // Initialize Three.js scene
            useEffect(() => {
                if (!mountRef.current) return;

                const THREE = window.THREE;
                if (!THREE) return;

                updateDebug('Creating Three.js scene...');

                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                const renderer = new THREE.WebGLRenderer({ 
                    antialias: false,
                    alpha: true,
                    preserveDrawingBuffer: true,
                    powerPreference: "high-performance"
                });
                const raycaster = new THREE.Raycaster();
                
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setClearColor(0x000011, 1);
                renderer.xr.enabled = true;
                renderer.shadowMap.enabled = false;
                mountRef.current.appendChild(renderer.domElement);

                // Stars
                const starGeometry = new THREE.BufferGeometry();
                const starMaterial = new THREE.PointsMaterial({ color: 0xffffff, size: 1 });
                const starVertices = [];
                for (let i = 0; i < 1000; i++) {
                    starVertices.push((Math.random() - 0.5) * 1000);
                    starVertices.push((Math.random() - 0.5) * 1000);
                    starVertices.push((Math.random() - 0.5) * 1000);
                }
                starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));
                scene.add(new THREE.Points(starGeometry, starMaterial));

                // Initial camera position
                camera.position.set(0, 2, 8);
                camera.lookAt(0, 0, 0);

                const clock = new THREE.Clock();

                // Lighting
                const ambientLight = new THREE.AmbientLight(0x404040, 0.5);
                scene.add(ambientLight);
                const sunLight = new THREE.PointLight(0xffffff, 1, 50);
                scene.add(sunLight);

                // Sun
                const sunGroup = new THREE.Group();
                const sunGeometry = new THREE.SphereGeometry(0.3, 16, 16);
                const sunMaterial = new THREE.MeshBasicMaterial({ 
                    color: 0xffaa00,
                    emissive: 0xffaa00,
                    emissiveIntensity: 0.5
                });
                
                const sun = new THREE.Mesh(sunGeometry, sunMaterial);
                sun.userData = sunData;
                sunGroup.add(sun);
                scene.add(sunGroup);

                // Planets
                const planets = [];
                planetData.forEach((planetInfo) => {
                    const geometry = new THREE.SphereGeometry(planetInfo.size, 16, 16);
                    const material = createSimplePlanetMaterial(planetInfo);
                    const planet = new THREE.Mesh(geometry, material);
                    
                    planet.userData = {
                        ...planetInfo,
                        angle: Math.random() * Math.PI * 2
                    };
                    
                    const angle = planet.userData.angle;
                    planet.position.x = Math.cos(angle) * planetInfo.distance;
                    planet.position.z = Math.sin(angle) * planetInfo.distance;
                    
                    scene.add(planet);
                    planets.push(planet);
                });

                updateDebug('Scene created. Drag to rotate!');

                // DRAG CONTROL EVENTS
                const handlePointerStart = (event) => {
                    if (arActive) return;
                    
                    event.preventDefault();
                    controls.current.isDragging = true;
                    
                    const clientX = event.touches ? event.touches[0].clientX : event.clientX;
                    const clientY = event.touches ? event.touches[0].clientY : event.clientY;
                    
                    controls.current.startX = clientX;
                    controls.current.startY = clientY;
                };

                const handlePointerMove = (event) => {
                    if (arActive || !controls.current.isDragging) return;
                    
                    event.preventDefault();
                    const clientX = event.touches ? event.touches[0].clientX : event.clientX;
                    const clientY = event.touches ? event.touches[0].clientY : event.clientY;
                    
                    const deltaX = clientX - controls.current.startX;
                    const deltaY = clientY - controls.current.startY;
                    
                    controls.current.rotationY += deltaX * 0.01;
                    controls.current.rotationX += deltaY * 0.01;
                    
                    // Limit vertical rotation
                    controls.current.rotationX = Math.max(-Math.PI/2, Math.min(Math.PI/2, controls.current.rotationX));
                    
                    controls.current.startX = clientX;
                    controls.current.startY = clientY;
                };

                const handlePointerEnd = (event) => {
                    controls.current.isDragging = false;
                };

                const handleWheel = (event) => {
                    if (arActive) return;
                    
                    event.preventDefault();
                    controls.current.distance += event.deltaY * 0.01;
                    controls.current.distance = Math.max(2, Math.min(20, controls.current.distance));
                };

                const handleClick = (event) => {
                    if (arActive || controls.current.isDragging) return;
                    
                    const rect = renderer.domElement.getBoundingClientRect();
                    const mouse = {
                        x: ((event.clientX - rect.left) / rect.width) * 2 - 1,
                        y: -((event.clientY - rect.top) / rect.height) * 2 + 1
                    };
                    
                    raycaster.setFromCamera(mouse, camera);
                    
                    const sunIntersects = raycaster.intersectObjects([sun]);
                    if (sunIntersects.length > 0) {
                        setSelectedPlanet(sunData);
                        setPlanetInfoPos({ x: event.clientX, y: event.clientY });
                        return;
                    }
                    
                    const intersects = raycaster.intersectObjects(planets);
                    if (intersects.length > 0) {
                        const planet = intersects[0].object;
                        setSelectedPlanet(planet.userData);
                        setPlanetInfoPos({ x: event.clientX, y: event.clientY });
                    } else {
                        setSelectedPlanet(null);
                    }
                };

                // Add all event listeners
                renderer.domElement.addEventListener('mousedown', handlePointerStart);
                renderer.domElement.addEventListener('mousemove', handlePointerMove);
                renderer.domElement.addEventListener('mouseup', handlePointerEnd);
                renderer.domElement.addEventListener('click', handleClick);
                renderer.domElement.addEventListener('wheel', handleWheel, { passive: false });
                
                renderer.domElement.addEventListener('touchstart', handlePointerStart, { passive: false });
                renderer.domElement.addEventListener('touchmove', handlePointerMove, { passive: false });
                renderer.domElement.addEventListener('touchend', handlePointerEnd, { passive: false });

                // Animation loop
                const animate = () => {
                    const deltaTime = clock.getDelta();
                    
                    if (arActive) {
                        renderer.setClearColor(0x000000, 0);
                    } else {
                        renderer.setClearColor(0x000011, 1);
                        
                        // UPDATE CAMERA BASED ON DRAG CONTROLS
                        const distance = controls.current.distance;
                        camera.position.x = distance * Math.sin(controls.current.rotationY) * Math.cos(controls.current.rotationX);
                        camera.position.y = distance * Math.sin(controls.current.rotationX);
                        camera.position.z = distance * Math.cos(controls.current.rotationY) * Math.cos(controls.current.rotationX);
                        camera.lookAt(0, 0, 0);
                    }
                    
                    // Animate sun
                    if (sunGroup) {
                        sunGroup.rotation.y += deltaTime * 0.5;
                    }
                    
                    // Animate planets
                    planets.forEach(planet => {
                        planet.userData.angle += deltaTime * planet.userData.speed * 0.02;
                        const distance = planet.userData.distance;
                        const angle = planet.userData.angle;
                        
                        planet.position.x = Math.cos(angle) * distance;
                        planet.position.z = Math.sin(angle) * distance;
                        planet.rotation.y += deltaTime * 0.5;
                    });
                    
                    renderer.render(scene, camera);
                };

                renderer.setAnimationLoop(animate);

                // Store refs
                sceneRef.current = scene;
                rendererRef.current = renderer;
                cameraRef.current = camera;
                planetsRef.current = planets;
                sunRef.current = sunGroup;
                clockRef.current = clock;
                raycasterRef.current = raycaster;

                const handleResize = () => {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                };
                window.addEventListener('resize', handleResize);

                return () => {
                    window.removeEventListener('resize', handleResize);
                    renderer.setAnimationLoop(null);
                    if (mountRef.current && renderer.domElement) {
                        mountRef.current.removeChild(renderer.domElement);
                    }
                    renderer.dispose();
                };
            }, [arActive]);

            // TIMEOUT WRAPPER FOR AR SESSION
            const requestSessionWithTimeout = (sessionMode, options = {}) => {
                return new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('AR session request timed out after 10 seconds'));
                    }, 10000); // 10 second timeout
                    
                    navigator.xr.requestSession(sessionMode, options)
                        .then(session => {
                            clearTimeout(timeout);
                            resolve(session);
                        })
                        .catch(error => {
                            clearTimeout(timeout);
                            reject(error);
                        });
                });
            };

            const startAR = async () => {
                if (!rendererRef.current) {
                    updateDebug('‚ùå Renderer not ready');
                    return;
                }
                
                if (!arSupported) {
                    updateDebug('‚ùå AR not supported on this device');
                    alert('AR not supported. Need Chrome Android or Safari iOS 15.4+');
                    return;
                }

                try {
                    updateDebug('üöÄ Requesting AR session (with timeout)...');
                    
                    // Try different AR session types with timeout
                    let session;
                    try {
                        // Try immersive AR first
                        session = await requestSessionWithTimeout('immersive-ar');
                        updateDebug('‚úÖ Immersive AR session created');
                    } catch (error) {
                        updateDebug(`‚ùå Immersive AR failed: ${error.message}`);
                        updateDebug('üîÑ Trying inline AR...');
                        
                        // Fallback to inline AR
                        try {
                            session = await requestSessionWithTimeout('inline');
                            updateDebug('‚úÖ Inline AR session created');
                        } catch (inlineError) {
                            throw new Error(`Both AR modes failed. Immersive: ${error.message}, Inline: ${inlineError.message}`);
                        }
                    }
                    
                    updateDebug('‚öôÔ∏è Setting up renderer...');
                    await rendererRef.current.xr.setSession(session);
                    updateDebug('‚úÖ Renderer setup complete');

                    // Scale down for AR
                    if (sunRef.current) {
                        sunRef.current.position.set(0, 0, -1);
                        sunRef.current.scale.setScalar(0.3);
                        
                        planetsRef.current.forEach(planet => {
                            const angle = planet.userData.angle;
                            const distance = planet.userData.distance * 0.3;
                            planet.position.x = Math.cos(angle) * distance;
                            planet.position.y = 0;
                            planet.position.z = -1 + Math.sin(angle) * distance;
                            planet.scale.setScalar(0.3);
                        });
                    }

                    setXrSession(session);
                    setArActive(true);
                    updateDebug('‚úÖ AR active! Look around!');

                    session.addEventListener('end', () => {
                        updateDebug('AR session ended');
                        
                        // Reset everything
                        if (sunRef.current) {
                            sunRef.current.position.set(0, 0, 0);
                            sunRef.current.scale.setScalar(1);
                            
                            planetsRef.current.forEach(planet => {
                                const angle = planet.userData.angle;
                                const distance = planet.userData.distance;
                                planet.position.x = Math.cos(angle) * distance;
                                planet.position.y = 0;
                                planet.position.z = Math.sin(angle) * distance;
                                planet.scale.setScalar(1);
                            });
                        }

                        setArActive(false);
                        setXrSession(null);
                        updateDebug('Back to 3D mode - drag to explore!');
                    });

                } catch (error) {
                    updateDebug(`‚ùå AR completely failed: ${error.message}`);
                    console.error('Full AR Error:', error);
                    
                    // Show user-friendly message
                    if (error.message.includes('timeout')) {
                        alert('AR timed out. Your browser might not support AR properly. Try Chrome Android or newer Safari iOS.');
                    } else if (error.message.includes('Permission')) {
                        alert('Camera permission needed for AR. Please allow camera access and try again.');
                    } else {
                        alert(`AR failed: ${error.message.substring(0, 100)}...`);
                    }
                }
            };

            return React.createElement('div', {
                style: { 
                    position: 'relative',
                    width: '100vw', 
                    height: '100vh',
                    background: '#000011',
                    color: 'white',
                    fontFamily: 'Arial, sans-serif',
                    overflow: 'hidden'
                }
            }, [
                // Three.js mount
                React.createElement('div', {
                    key: 'mount',
                    ref: mountRef,
                    style: { position: 'absolute', top: 0, left: 0 }
                }),
                
                // Title
                React.createElement('div', {
                    key: 'title',
                    style: {
                        position: 'absolute',
                        top: '15px',
                        left: '15px',
                        zIndex: 10,
                        background: 'rgba(0,0,0,0.8)',
                        padding: '10px 20px',
                        borderRadius: '10px',
                        border: '1px solid rgba(255,255,255,0.2)'
                    }
                }, [
                    React.createElement('h2', {
                        key: 'h2',
                        style: { 
                            margin: 0,
                            fontSize: '1.3em',
                            background: 'linear-gradient(45deg, #ff6b35, #f7931e)',
                            WebkitBackgroundClip: 'text',
                            WebkitTextFillColor: 'transparent'
                        }
                    }, `üåû Solar System ${arActive ? 'AR' : '3D'}`)
                ]),

                // Debug Info
                React.createElement('div', {
                    key: 'debug',
                    className: 'debug-info'
                }, debugInfo),

                // AR Control
                React.createElement('button', {
                    key: 'ar-btn',
                    onClick: startAR,
                    style: {
                        position: 'absolute',
                        top: '15px',
                        right: '15px',
                        padding: '12px 18px',
                        fontSize: '1em',
                        background: arSupported 
                            ? 'linear-gradient(45deg, #ff6b35, #f7931e)' 
                            : 'linear-gradient(45deg, #666, #888)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '20px',
                        cursor: 'pointer',
                        zIndex: 10
                    }
                }, arActive ? 'Exit AR' : (arSupported ? 'üöÄ Try AR' : '‚ùå AR Unsupported')),

                // Planet info popup
                selectedPlanet && React.createElement('div', {
                    key: 'planet-info',
                    className: 'planet-info',
                    style: {
                        left: Math.min(planetInfoPos.x, window.innerWidth - 320) + 'px',
                        top: Math.min(planetInfoPos.y, window.innerHeight - 250) + 'px'
                    }
                }, [
                    React.createElement('button', {
                        key: 'close',
                        className: 'close-btn',
                        onClick: () => setSelectedPlanet(null)
                    }, '√ó'),
                    React.createElement('h3', { key: 'name' }, `ü™ê ${selectedPlanet.name}`),
                    React.createElement('p', { key: 'diameter' }, `üìè Diameter: ${selectedPlanet.details.diameter}`),
                    React.createElement('p', { key: 'distance' }, `üöÄ Distance: ${selectedPlanet.details.distance}`),
                    React.createElement('p', { key: 'facts', style: { fontStyle: 'italic', color: '#ffa500' } }, selectedPlanet.details.facts)
                ]),

                // Bottom instructions
                React.createElement('div', {
                    key: 'instructions',
                    style: {
                        position: 'absolute',
                        bottom: '15px',
                        left: '15px',
                        right: '15px',
                        background: 'rgba(0,0,0,0.8)',
                        padding: '10px',
                        borderRadius: '10px',
                        textAlign: 'center',
                        fontSize: '0.9em',
                        zIndex: 10
                    }
                }, arActive ? 
                    'üì± Move your phone to explore AR!' : 
                    'üñ±Ô∏è Drag to rotate ‚Ä¢ üîÑ Scroll to zoom ‚Ä¢ üëÜ Click planets for info'
                )
            ]);
        };

        const { createRoot } = ReactDOM;
        const root = createRoot(document.getElementById('root'));
        root.render(React.createElement(SolarSystemAR));
    </script>
</body>
</html>
