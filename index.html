<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Solar System AR - iOS Fixed Version</title>
    
    <!-- Using Three.js r126 for better iOS compatibility -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r126/three.min.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #000011;
            color: white;
        }
        
        #scene-container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        
        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 100;
        }
        
        .ui-overlay > * {
            pointer-events: auto;
        }
        
        .title-card {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(0, 0, 0, 0.85);
            padding: 12px 18px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 107, 53, 0.3);
        }
        
        .title-card h2 {
            margin: 0;
            font-size: 1.2em;
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .title-card p {
            margin: 5px 0 0 0;
            font-size: 0.85em;
            opacity: 0.9;
        }
        
        .ar-button {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 12px 20px;
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            border: none;
            border-radius: 25px;
            color: white;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .ar-button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 20px rgba(255, 107, 53, 0.4);
        }
        
        .ar-button.disabled {
            background: linear-gradient(45deg, #666, #888);
            cursor: not-allowed;
        }
        
        .status-message {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 12px 24px;
            border-radius: 20px;
            font-size: 0.9em;
            max-width: 80%;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        .status-message.error {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid rgba(255, 0, 0, 0.5);
        }
        
        .status-message.success {
            background: rgba(0, 255, 0, 0.2);
            border: 1px solid rgba(0, 255, 0, 0.5);
        }
        
        .planet-info {
            position: absolute;
            background: rgba(0, 0, 0, 0.95);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #ff6b35;
            max-width: 300px;
            backdrop-filter: blur(10px);
            display: none;
        }
        
        .planet-info.active {
            display: block;
        }
        
        .planet-info h3 {
            margin: 0 0 10px 0;
            color: #ff6b35;
        }
        
        .planet-info p {
            margin: 5px 0;
            font-size: 0.9em;
        }
        
        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: #ff6b35;
            font-size: 1.5em;
            cursor: pointer;
        }
        
        .permission-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .permission-modal.active {
            display: flex;
        }
        
        .permission-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 30px;
            border-radius: 20px;
            max-width: 400px;
            text-align: center;
            border: 2px solid #ff6b35;
        }
        
        .permission-content h3 {
            color: #ff6b35;
            margin-bottom: 15px;
        }
        
        .permission-content button {
            margin-top: 20px;
            padding: 12px 30px;
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            border: none;
            border-radius: 25px;
            color: white;
            font-size: 1em;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="scene-container"></div>
    
    <div class="ui-overlay">
        <div class="title-card">
            <h2>🌌 Solar System AR</h2>
            <p id="mode-indicator">3D Mode - Drag to explore</p>
        </div>
        
        <button id="ar-button" class="ar-button">
            🚀 Start AR
        </button>
        
        <div id="status-message" class="status-message"></div>
        
        <div id="planet-info" class="planet-info">
            <button class="close-btn" onclick="closePlanetInfo()">×</button>
            <h3 id="planet-name"></h3>
            <p id="planet-details"></p>
        </div>
    </div>
    
    <div id="permission-modal" class="permission-modal">
        <div class="permission-content">
            <h3>📸 Camera & Motion Access Needed</h3>
            <p>To place planets in your room, we need access to:</p>
            <ul style="text-align: left;">
                <li>Camera - to see your environment</li>
                <li>Motion sensors - to track your movement</li>
            </ul>
            <p>Please tap "Allow" when prompted.</p>
            <button onclick="requestPermissions()">Grant Permissions</button>
        </div>
    </div>

    <script>
        // Global variables
        let scene, camera, renderer;
        let planets = [];
        let sun = null;
        let animationId = null;
        let isARMode = false;
        let xrSession = null;
        let referenceSpace = null;
        let hitTestSource = null;
        let reticle = null;
        let placedObjects = false;
        
        // Check if we're on iOS
        const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
        const isXRBrowser = navigator.userAgent.includes('WebXRViewer') || 
                           navigator.userAgent.includes('XRBrowser') ||
                           window.navigator.xr !== undefined;
        
        // Planet data
        const planetData = [
            { name: 'Mercury', size: 0.05, distance: 0.4, speed: 0.8, color: 0x8c7853, info: 'Smallest planet, closest to the Sun' },
            { name: 'Venus', size: 0.08, distance: 0.6, speed: 0.6, color: 0xffc649, info: 'Hottest planet, thick atmosphere' },
            { name: 'Earth', size: 0.08, distance: 0.8, speed: 0.5, color: 0x6b93d6, info: 'Our home planet, perfect for life' },
            { name: 'Mars', size: 0.06, distance: 1.0, speed: 0.4, color: 0xc1440e, info: 'The Red Planet, has polar ice caps' },
            { name: 'Jupiter', size: 0.15, distance: 1.5, speed: 0.25, color: 0xd8ca9d, info: 'Largest planet, has a Great Red Spot' },
            { name: 'Saturn', size: 0.12, distance: 2.0, speed: 0.2, color: 0xfad5a5, info: 'Famous for its beautiful rings' },
            { name: 'Uranus', size: 0.10, distance: 2.5, speed: 0.15, color: 0x4fd0e3, info: 'Tilted on its side, ice giant' },
            { name: 'Neptune', size: 0.10, distance: 3.0, speed: 0.1, color: 0x4b70dd, info: 'Windiest planet, deep blue color' }
        ];
        
        // Initialize the 3D scene
        function init() {
            showStatus('Initializing Solar System...', 'normal');
            
            const container = document.getElementById('scene-container');
            
            // Create scene
            scene = new THREE.Scene();
            
            // Create camera
            camera = new THREE.PerspectiveCamera(
                75,
                window.innerWidth / window.innerHeight,
                0.1,
                1000
            );
            camera.position.set(0, 1, 3);
            
            // Create renderer with proper settings for AR
            renderer = new THREE.WebGLRenderer({
                antialias: true,
                alpha: true, // Important for AR transparency
                preserveDrawingBuffer: true
            });
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.outputEncoding = THREE.sRGBEncoding;
            renderer.xr.enabled = true; // Enable WebXR
            container.appendChild(renderer.domElement);
            
            // Add lights
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 10, 10);
            scene.add(directionalLight);
            
            // Create the solar system
            createSolarSystem();
            
            // Add controls for 3D mode
            setupControls();
            
            // Start animation
            animate();
            
            // Check AR support
            checkARSupport();
            
            showStatus('Solar System ready! Drag to explore.', 'success');
        }
        
        // Create the solar system
        function createSolarSystem() {
            // Create the Sun
            const sunGeometry = new THREE.SphereGeometry(0.2, 32, 32);
            const sunMaterial = new THREE.MeshBasicMaterial({
                color: 0xffff00,
                emissive: 0xffff00,
                emissiveIntensity: 0.5
            });
            sun = new THREE.Mesh(sunGeometry, sunMaterial);
            scene.add(sun);
            
            // Create planets
            planetData.forEach(data => {
                const planetGroup = new THREE.Group();
                
                // Planet mesh
                const geometry = new THREE.SphereGeometry(data.size, 32, 32);
                const material = new THREE.MeshPhongMaterial({
                    color: data.color,
                    shininess: 30
                });
                const planet = new THREE.Mesh(geometry, material);
                planet.userData = data;
                
                // Position planet
                const angle = Math.random() * Math.PI * 2;
                planet.userData.angle = angle;
                planet.position.x = Math.cos(angle) * data.distance;
                planet.position.z = Math.sin(angle) * data.distance;
                
                planetGroup.add(planet);
                
                // Add rings to Saturn
                if (data.name === 'Saturn') {
                    const ringGeometry = new THREE.RingGeometry(
                        data.size * 1.2,
                        data.size * 2,
                        64
                    );
                    const ringMaterial = new THREE.MeshBasicMaterial({
                        color: 0xfad5a5,
                        side: THREE.DoubleSide,
                        transparent: true,
                        opacity: 0.4
                    });
                    const rings = new THREE.Mesh(ringGeometry, ringMaterial);
                    rings.rotation.x = Math.PI / 2;
                    planet.add(rings);
                }
                
                scene.add(planetGroup);
                planets.push({ group: planetGroup, mesh: planet, data: data });
            });
        }
        
        // Setup mouse/touch controls for 3D mode
        function setupControls() {
            let isRotating = false;
            let previousMousePosition = { x: 0, y: 0 };
            
            renderer.domElement.addEventListener('mousedown', startRotation);
            renderer.domElement.addEventListener('touchstart', startRotation);
            
            function startRotation(e) {
                if (isARMode) return;
                isRotating = true;
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                previousMousePosition = { x: clientX, y: clientY };
            }
            
            renderer.domElement.addEventListener('mousemove', rotate);
            renderer.domElement.addEventListener('touchmove', rotate);
            
            function rotate(e) {
                if (!isRotating || isARMode) return;
                
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                
                const deltaX = clientX - previousMousePosition.x;
                const deltaY = clientY - previousMousePosition.y;
                
                scene.rotation.y += deltaX * 0.01;
                scene.rotation.x += deltaY * 0.01;
                
                previousMousePosition = { x: clientX, y: clientY };
            }
            
            renderer.domElement.addEventListener('mouseup', () => isRotating = false);
            renderer.domElement.addEventListener('touchend', () => isRotating = false);
            
            // Add zoom with wheel
            renderer.domElement.addEventListener('wheel', (e) => {
                if (isARMode) return;
                camera.position.z += e.deltaY * 0.001;
                camera.position.z = Math.max(1, Math.min(10, camera.position.z));
            });
        }
        
        // Animation loop
        function animate() {
            animationId = requestAnimationFrame(animate);
            
            if (!isARMode) {
                // Rotate sun
                if (sun) {
                    sun.rotation.y += 0.005;
                }
                
                // Animate planets
                planets.forEach(({ mesh, data }) => {
                    mesh.userData.angle += data.speed * 0.01;
                    const angle = mesh.userData.angle;
                    mesh.position.x = Math.cos(angle) * data.distance;
                    mesh.position.z = Math.sin(angle) * data.distance;
                    mesh.rotation.y += 0.01;
                });
            }
            
            renderer.render(scene, camera);
        }
        
        // Check AR support
        async function checkARSupport() {
            const arButton = document.getElementById('ar-button');
            
            if (!navigator.xr) {
                arButton.textContent = '❌ AR Not Supported';
                arButton.classList.add('disabled');
                showStatus('WebXR not available. Try using XR Browser on iOS.', 'error');
                return;
            }
            
            try {
                const supported = await navigator.xr.isSessionSupported('immersive-ar');
                if (supported) {
                    arButton.onclick = startAR;
                    showStatus('AR is supported! Tap the button to start.', 'success');
                } else {
                    arButton.textContent = '❌ AR Not Available';
                    arButton.classList.add('disabled');
                    showStatus('AR not supported on this device.', 'error');
                }
            } catch (error) {
                console.error('AR check failed:', error);
                arButton.textContent = '⚠️ AR Check Failed';
                arButton.classList.add('disabled');
                showStatus('Could not check AR support.', 'error');
            }
        }
        
        // Start AR session with proper iOS handling
        async function startAR() {
            // For XR Browser, try direct initialization first
            if (isXRBrowser) {
                showStatus('Starting AR directly for XR Browser...', 'normal');
                try {
                    // Try direct AR initialization without permission modal
                    await initializeARDirect();
                } catch (error) {
                    console.log('Direct AR failed, trying with permissions:', error);
                    // Fall back to permission flow
                    if (isIOS) {
                        document.getElementById('permission-modal').classList.add('active');
                    } else {
                        await initializeAR();
                    }
                }
            } else if (isIOS) {
                // Show permission modal for iOS Safari/other browsers
                document.getElementById('permission-modal').classList.add('active');
            } else {
                await initializeAR();
            }
        }
        
        // Direct AR initialization for XR Browser
        async function initializeARDirect() {
            try {
                // Request minimal session first
                const testSession = await navigator.xr.requestSession('immersive-ar', {
                    optionalFeatures: ['dom-overlay'],
                    domOverlay: { root: document.body }
                });
                
                // If we get here, permissions are OK
                await testSession.end();
                
                // Now start the real session
                await initializeAR();
            } catch (error) {
                throw error;
            }
        }
        
        // Request iOS permissions with better handling
        async function requestPermissions() {
            document.getElementById('permission-modal').classList.remove('active');
            showStatus('Requesting permissions...', 'normal');
            
            try {
                // For iOS 13+, request device orientation permission first
                if (typeof DeviceOrientationEvent !== 'undefined' && 
                    typeof DeviceOrientationEvent.requestPermission === 'function') {
                    try {
                        const orientationPermission = await DeviceOrientationEvent.requestPermission();
                        console.log('Orientation permission:', orientationPermission);
                    } catch (e) {
                        console.log('Orientation permission failed:', e);
                    }
                }
                
                // Request device motion permission for iOS 13+
                if (typeof DeviceMotionEvent !== 'undefined' && 
                    typeof DeviceMotionEvent.requestPermission === 'function') {
                    const motionPermission = await DeviceMotionEvent.requestPermission();
                    console.log('Motion permission:', motionPermission);
                    if (motionPermission !== 'granted') {
                        throw new Error('Motion permission denied. Please go to Settings > XR Browser and enable Motion & Fitness.');
                    }
                }
                
                // Request camera permission with better error handling
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { 
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        },
                        audio: false
                    });
                    // Stop the stream immediately - we just needed permission
                    stream.getTracks().forEach(track => track.stop());
                    console.log('Camera permission granted');
                } catch (cameraError) {
                    if (cameraError.name === 'NotAllowedError') {
                        throw new Error('Camera permission denied. Please go to Settings > XR Browser and enable Camera access.');
                    } else if (cameraError.name === 'NotFoundError') {
                        throw new Error('No camera found on device.');
                    } else {
                        throw new Error(`Camera error: ${cameraError.message}`);
                    }
                }
                
                // Small delay to ensure permissions are registered
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Now initialize AR
                await initializeAR();
                
            } catch (error) {
                console.error('Permission error:', error);
                showStatus(error.message || 'Permissions denied. AR cannot start.', 'error');
                
                // Show additional help for iOS users
                if (isIOS) {
                    setTimeout(() => {
                        showStatus('Tip: Go to Settings > XR Browser and check all permissions are enabled', 'normal');
                    }, 3500);
                }
            }
        }
        
        // Initialize AR with fallback reference spaces
        async function initializeAR() {
            showStatus('Starting AR session...', 'normal');
            
            try {
                // Request AR session
                xrSession = await navigator.xr.requestSession('immersive-ar', {
                    requiredFeatures: ['hit-test'],
                    optionalFeatures: ['dom-overlay'],
                    domOverlay: { root: document.body }
                });
                
                // Set up session
                await renderer.xr.setSession(xrSession);
                
                // Try reference spaces in order of preference
                const referenceSpaceTypes = ['local-floor', 'local', 'viewer'];
                
                for (const spaceType of referenceSpaceTypes) {
                    try {
                        referenceSpace = await xrSession.requestReferenceSpace(spaceType);
                        console.log(`Using ${spaceType} reference space`);
                        showStatus(`AR active - using ${spaceType} tracking`, 'success');
                        break;
                    } catch (e) {
                        console.log(`${spaceType} not supported, trying next...`);
                    }
                }
                
                if (!referenceSpace) {
                    throw new Error('No supported reference space available');
                }
                
                // Create reticle for placement
                createReticle();
                
                // Set up hit testing
                const viewerSpace = await xrSession.requestReferenceSpace('viewer');
                hitTestSource = await xrSession.requestHitTestSource({
                    space: viewerSpace
                });
                
                // Update UI
                isARMode = true;
                document.getElementById('ar-button').textContent = '🛑 Exit AR';
                document.getElementById('ar-button').onclick = exitAR;
                document.getElementById('mode-indicator').textContent = 'AR Mode - Point at floor & tap to place';
                
                // Scale down solar system for AR
                scene.scale.set(0.1, 0.1, 0.1);
                
                // Set up AR render loop
                renderer.xr.addEventListener('sessionstart', onXRSessionStart);
                renderer.xr.addEventListener('sessionend', onXRSessionEnd);
                
                // Handle session end
                xrSession.addEventListener('end', () => {
                    isARMode = false;
                    xrSession = null;
                    referenceSpace = null;
                    hitTestSource = null;
                    showStatus('AR session ended', 'normal');
                });
                
            } catch (error) {
                console.error('AR initialization failed:', error);
                showStatus(`AR failed: ${error.message}`, 'error');
                
                // Clean up on failure
                if (xrSession) {
                    await xrSession.end();
                }
            }
        }
        
        // Create reticle for AR placement
        function createReticle() {
            const geometry = new THREE.RingGeometry(0.15, 0.2, 32);
            const material = new THREE.MeshBasicMaterial({
                color: 0xff6b35,
                transparent: true,
                opacity: 0.75
            });
            reticle = new THREE.Mesh(geometry, material);
            reticle.rotation.x = -Math.PI / 2;
            reticle.visible = false;
            scene.add(reticle);
        }
        
        // XR session callbacks
        function onXRSessionStart() {
            console.log('XR session started');
        }
        
        function onXRSessionEnd() {
            console.log('XR session ended');
            scene.scale.set(1, 1, 1);
        }
        
        // Exit AR
        async function exitAR() {
            if (xrSession) {
                await xrSession.end();
            }
            
            // Reset UI
            document.getElementById('ar-button').textContent = '🚀 Start AR';
            document.getElementById('ar-button').onclick = startAR;
            document.getElementById('mode-indicator').textContent = '3D Mode - Drag to explore';
            
            // Reset scale
            scene.scale.set(1, 1, 1);
            
            isARMode = false;
        }
        
        // Show status messages
        function showStatus(message, type = 'normal') {
            const statusElement = document.getElementById('status-message');
            statusElement.textContent = message;
            statusElement.className = 'status-message';
            
            if (type === 'error') {
                statusElement.classList.add('error');
            } else if (type === 'success') {
                statusElement.classList.add('success');
            }
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                statusElement.textContent = '';
                statusElement.className = 'status-message';
            }, 3000);
        }
        
        // Planet info functions
        function showPlanetInfo(planet) {
            const info = document.getElementById('planet-info');
            document.getElementById('planet-name').textContent = planet.name;
            document.getElementById('planet-details').textContent = planet.info;
            info.classList.add('active');
        }
        
        function closePlanetInfo() {
            document.getElementById('planet-info').classList.remove('active');
        }
        
        // Handle window resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
        
        // Initialize when page loads
        window.addEventListener('load', init);
        
        // Add click/tap handler for planets
        window.addEventListener('click', (event) => {
            const raycaster = new THREE.Raycaster();
            const mouse = new THREE.Vector2();
            
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            
            raycaster.setFromCamera(mouse, camera);
            
            const planetMeshes = planets.map(p => p.mesh);
            const intersects = raycaster.intersectObjects(planetMeshes);
            
            if (intersects.length > 0) {
                const planet = intersects[0].object.userData;
                showPlanetInfo(planet);
            }
        });
    </script>
</body>
</html>
